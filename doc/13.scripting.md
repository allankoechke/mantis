# Scripting
On server run execution, Mantis searches for a script file named `index.mantis.js` as an entry point into loading scripts into context. Once file is executed, ay actions are evaluated and methods stored for subsequent invokation by the C++ engine as needed. This is important for tasks like requests that reqires signature registration then when a new request comes in, we will route the request to the Javascript handler and/or middlewares.

The file `index.mantis.js` is expected to be in the global apps scripts directory which is set either by:
- By default, relative to the `mantisapp` binary in a directory called `scripts`
- We can override this directory by setting the desired directory using the cmd arg `--scriptsDir /some/path`. See CMD options in the docs for more information.

## Application
dukglue_register_property(m_dukCtx, &MantisApp::host, &MantisApp::setHost, "host");
dukglue_register_property(m_dukCtx, &MantisApp::port, &MantisApp::setPort, "port");
dukglue_register_property(m_dukCtx, &MantisApp::poolSize, &MantisApp::setPoolSize, "poolSize");
dukglue_register_property(m_dukCtx, &MantisApp::publicDir, &MantisApp::setPublicDir, "publicDir");
dukglue_register_property(m_dukCtx, &MantisApp::dataDir, &MantisApp::setDataDir, "dataDir");
dukglue_register_property(m_dukCtx, &MantisApp::isDevMode, nullptr, "devMode");
dukglue_register_property(m_dukCtx, &MantisApp::dbTypeByName, nullptr, "dbType");
dukglue_register_property(m_dukCtx, &MantisApp::jwtSecretKey_JSWrapper, nullptr, "secretKey");
dukglue_register_property(m_dukCtx, &MantisApp::version_JSWrapper, nullptr, "version");

        dukglue_register_method(m_dukCtx, &MantisApp::close, "close");
        dukglue_register_method(m_dukCtx, &MantisApp::duk_db, "db");

        MantisRequest::registerDuktapeMethods();
        MantisResponse::registerDuktapeMethods();

        dukglue_register_method_varargs(m_dukCtx, &MantisApp::addRoute, "addRoute");

        // dukglue_register_method(m_dukCtx, &MantisApp::http, "http");
        // dukglue_register_method(m_dukCtx, &MantisApp::router, "router");
        // dukglue_register_method(m_dukCtx, &MantisApp::validators, "validator");
        // dukglue_register_method(m_dukCtx, &MantisApp::settings, "settings");
        // dukglue_register_method(m_dukCtx, &MantisApp::files, "files");

        // ---------------------------------------------- //
        // Register `console` object
        // ---------------------------------------------- //
        // Create console object and register methods
        duk_push_object(m_dukCtx);

        duk_push_c_function(m_dukCtx, &DuktapeImpl::nativeConsoleInfo, DUK_VARARGS);
        duk_put_prop_string(m_dukCtx, -2, "info");

        duk_push_c_function(m_dukCtx, &DuktapeImpl::nativeConsoleTrace, DUK_VARARGS);
        duk_put_prop_string(m_dukCtx, -2, "trace");

        duk_push_c_function(m_dukCtx, &DuktapeImpl::nativeConsoleInfo, DUK_VARARGS);
        duk_put_prop_string(m_dukCtx, -2, "log");

        duk_put_global_string(m_dukCtx, "console");

        // UTILS methods
        registerUtilsToDuktapeEngine();

        // DATABASE methods
        DatabaseUnit::registerDuktapeMethods();

## Database
dukglue_register_property(ctx, &DatabaseUnit::isConnected, nullptr, "connected");
dukglue_register_method(ctx, &DatabaseUnit::session, "session");

    // soci::session methods
    dukglue_register_method(ctx, &soci::session::close, "close");
    dukglue_register_method(ctx, &soci::session::reconnect, "reconnect");
    dukglue_register_property(ctx, &soci::session::is_connected, nullptr, "connected");
    dukglue_register_method(ctx, &soci::session::begin, "begin");
    dukglue_register_method(ctx, &soci::session::commit, "commit");
    dukglue_register_method(ctx, &soci::session::rollback, "rollback");
    dukglue_register_method(ctx, &soci::session::get_query, "getQuery");
    dukglue_register_method(ctx, &soci::session::get_last_query, "getLastQuery");
    dukglue_register_method(ctx, &soci::session::get_last_query_context, "getLastQueryContext");
    dukglue_register_method(ctx, &soci::session::got_data, "gotData");
    dukglue_register_method(ctx, &soci::session::get_last_insert_id, "getLastInsertId");
    dukglue_register_method(ctx, &soci::session::get_backend_name, "getBackendName");
    dukglue_register_method(ctx, &soci::session::empty_blob, "emptyBlob");

## Requests
To add a new request endpoint in JS, Mantis exposes a `addRoute` method having the following signature:

```js
app.addRoute({method} {path} {function_handler}) 
// With Middlewares
app.addRoute({method} {path} {function_handler}, {middleware}, {middleware}, ...)
```
Let's add a `/test` route.
```js
app.addRoute("GET", "/test", function (req, res){
    // Request Handler Method
    res.json(200, JSON.stringify({a: 5, b: 4}))
}) 

// With one or more middlewares
app.addRoute("GET", "/test", function (req, res){
    // Request Handler Method
    res.json(200, JSON.stringify({a: 5, b: 4}))
}, function (req, res){
    // Handler Body
    
    // If the middleware is successful, return true
    // if we encounter an error, return false to abort route execution
    return true
}) 
```

To access the request metadata as well as set response metadata, the handler or middleware method passes in two arguments, the request object (shown as `req` above) and the response object (shown as `res` above).

The `req` object maps to `MantisRequest` and `res` maps to `MantisResponse` class in C++.

### Middlewares
Middlewares in Mantis carries the same function signature as the request handler with just one tiny difference. The middlewares return a `bool` type, indicating whether or not the middleware executed successfully. That is;
- Return `true`: Middleware execution succeeded, proceed to the next handler and or handler.
- Return `false`: Middleware execution failed, abort request.

```js
function checkIfAuthenticated(req, res) {
    var authenticated = false;

    // Do your magic here
    var token = req.getHeader("Authorization", "", 0)
    // Validate token ...
    // Other magic?
    // authenticated = ....
    
    return authenticated
}

// Middleware is executed first before the handler
app.addRoute("POST", "/foo/bar", function (req, res) {}, checkIfAuthenticated)
```

> Warning
> Note that, middlewares are executed from the first to the last in that order. That is,
> `app.addRoute(...., middleware_1, middleware_2, function(req, res){ return true}, ...)` executing from `middleware_1` to `middleware_n` the finally invoking the handler.

### MantisRequest Methods/Properties
// `req.hasHeader("Authorization")` -> return true/false
dukglue_register_method(ctx, &MantisRequest::has_header, "hasHeader");
// `req.getHeader("Authorization", "", 0)` -> Return Authorization value or default
// `req.getHeader("Authorization", "Default Value", 0)` -> Return Authorization value or default
// `req.getHeader("Some Key", "Default Value", 1)` -> Return 'Some Key' value if exists of index '1' or default
dukglue_register_method(ctx, &MantisRequest::get_header_value, "getHeader");
dukglue_register_method(ctx, &MantisRequest::get_header_value_u64, "getHeaderU64");
// `req.getHeaderCount("key")` -> Count for header values given the header key
dukglue_register_method(ctx, &MantisRequest::get_header_value_count, "getHeaderCount");
// req.setHeader("Cow", "Cow Value")
dukglue_register_method(ctx, &MantisRequest::set_header, "setHeader");

        dukglue_register_method(ctx, &MantisRequest::has_trailer, "hasTrailer");
        dukglue_register_method(ctx, &MantisRequest::get_trailer_value, "getTrailer");
        dukglue_register_method(ctx, &MantisRequest::get_trailer_value_count, "getTrailerCount");

        // `req.hasQueryParam("key")` -> return true/false
        dukglue_register_method(ctx, &MantisRequest::has_query_param, "hasQueryParam");
        // `req.getQueryParam("key")` -> Return header value given the key
        dukglue_register_method(ctx, static_cast<std::string(MantisRequest::*)(const std::string&) const>(&MantisRequest::get_query_param_value), "getQueryParam");
        // `req.getQueryParamCount("key")` -> Return parameter value count
        dukglue_register_method(ctx, &MantisRequest::get_query_param_value_count, "getQueryParamCount");

        // `req.hasPathParam("key")` -> return true/false
        dukglue_register_method(ctx, &MantisRequest::has_path_param, "hasPathParam");
        // `req.getPathParam("key")` -> Return header value given the key
        dukglue_register_method(ctx, static_cast<std::string(MantisRequest::*)(const std::string&) const>(&MantisRequest::get_path_param_value), "getPathParam");
        // `req.getPathParamCount("key")` -> Return parameter value count
        dukglue_register_method(ctx, &MantisRequest::get_path_param_value_count, "getPathParamCount");

        // `req.isMultipartFormData()` -> Return true if request type is of Multipart/FormData
        dukglue_register_method(ctx, &MantisRequest::is_multipart_form_data, "isMultipartFormData");

        // `req.body` -> Get request body data
        dukglue_register_property(ctx, &MantisRequest::get_body, nullptr, "body");
        // `req.method` -> Get request method ('GET', 'POST', ...)
        dukglue_register_property(ctx, &MantisRequest::get_method, nullptr, "method");
        // `req.path` -> Get request path value

### MantisResponse Methods/Properties
- `res.hasHeader("Authorization")`: Check if a header `key` exists in the request header. Returns true or false.
- `res.getHeader(<key>, <default>, <index>)`: Get header value for a given `key` in the header. All three parameters are required, `key` being the header of interest, `default` being the base value if header is not found and `index` being the 0-based index for the item to return if the header value has more than one value. i.e 
```js
    const token = res.getHeader("Authorization", "", 0)
    const type = res.getHeader("content-type", "text/plain", 0)
```
- `res.getHeaderCount("key")` -> Count for header values given the header key
- `res.setHeader("Cow", "Cow Value")`
- `res.hasTrailer`
- `res.getTrailer`
- `res.getTrailerCount`
- `res.redirect("http://some-url.com", 302)`
- `res.setContent(content, content_type)`: i.e. `res.setContent("<html>...</html>", "text/html")`
- `res.setFileContent("/foo/file_path")`
- `res.send(200, "some data here", "text/plain")`
- `res.json(200, "{\"a\": 5}")`
- `res.html(200, "<html> ... </html>")`
- `res.text(200, "some text response")`
- `res.empty(204)`
- `res.body = "Some Data"`
- `res.body` -> returns `Some Data`
- `res.status` (get or set status data)
- `res.version` (get or set version value)
- `res.location` (get or set redirect location value)
- `res.reason` (get or set reason value)

## Utils (utility functions)
dukglue_register_function(ctx, &generateTimeBasedId, "generateTimeBasedId");
dukglue_register_function(ctx, &generateReadableTimeId, "generateReadableTimeId");
dukglue_register_function(ctx, &generateShortId, "generateShortId");
dukglue_register_function(ctx, &getEnvOrDefault, "getEnvOrDefault");
dukglue_register_function(ctx, &sanitizeFilename_JSWrapper, "sanitizeFilename");
dukglue_register_function(ctx, &bcryptBase64EncodeStr, "bcryptBase64Encode");
dukglue_register_function(ctx, &generateSalt, "generateSalt");
dukglue_register_function(ctx, &hashPasswordJS, "hashPassword");
dukglue_register_function(ctx, &verifyPasswordJS, "verifyPassword");