<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Mantis App: Scripting in Mantis</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="doxygen-awesome.css" rel="stylesheet" type="text/css"/>
<link href="doxygen-awesome-sidebar-only.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectlogo"><img alt="Logo" src="mantis.png"/></td>
  <td id="projectalign">
   <div id="projectname">Mantis App<span id="projectnumber">&#160;v0.2.10</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.8 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('scripting.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Scripting in Mantis</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1><a class="anchor" id="autotoc_md151"></a>
Scripting</h1>
<p>On server run execution, Mantis searches for a script file named <code>index.mantis.js</code> as an entry point into loading scripts into context. Once file is executed, ay actions are evaluated and methods stored for subsequent invokation by the C++ engine as needed. This is important for tasks like requests that reqires signature registration then when a new request comes in, we will route the request to the Javascript handler and/or middlewares.</p>
<p>The file <code>index.mantis.js</code> is expected to be in the global apps scripts directory which is set either by:</p><ul>
<li>By default, relative to the <code>mantisapp</code> binary in a directory called <code>scripts</code></li>
<li>We can override this directory by setting the desired directory using the cmd arg <code>--scriptsDir /some/path</code>. See CMD options in the docs for more information.</li>
</ul>
<h2><a class="anchor" id="autotoc_md152"></a>
Application</h2>
<p>Mantis exposes a global object <code>app</code> that provides access to the following properties. Despite them being both <code>READ</code> and <code>WRITE</code>, note that some of these properties are evaluated only once when initializing, as such, update to the values will not have any impact.</p><ul>
<li><code>app.host</code>:Get HTTP server host, by default <code>0.0.0.0</code>.</li>
<li><code>app.port</code>: Get HTTP server port, by default <code>7070</code>.</li>
<li><code>app.poolSize</code>: Get the database connection pool size, 2 for SQLite, 10 for PostgreSQL.</li>
<li><code>app.publicDir</code>: Get/Set the public directory for serving static files (html, css, js, etc.)</li>
<li><code>app.dataDir</code>: Get/Set the directory for storing database files in <em>SQLite</em> backend and file assets linked in database records.</li>
<li><code>app.devMode</code>: Get/Set the developer mode to log trace information on the console.</li>
<li><code>app.dbType</code>: Get the database type used, by default it's <em>SQLite</em>.</li>
<li><code>app.secretKey</code>: Get/Set secret key used in signing JWT tokens.</li>
<li><code>app.version</code>: Get Mantis version.</li>
</ul>
<p>Additionally, some methods are exposed on the <code>app</code> object:</p><ul>
<li><code>app.close()</code>: Close the application gracefully.</li>
<li><code>app.quit(exitCode, reason)</code>: Close the application gracefully with a <em>exitCode</em> and a <em>reason</em>.</li>
<li><code>app.db()</code>: Get the database unit instance.</li>
<li><code>app.addRoute(method, path, handler, [middlewares])</code>: Create a route for a given HTTP method, on a given <em>path</em> with the given handler function with optional middleware functions.</li>
</ul>
<h2><a class="anchor" id="autotoc_md153"></a>
Database</h2>
<p>The <code>DatabaseUnit</code> object returned from the <code>app.db()</code> method exposes the following methods and properties: </p><div class="fragment"><div class="line">const db = app.db() // Get db unit instance</div>
</div><!-- fragment --><ul>
<li><code>db.connected</code>: Property to read the connection state to the database.</li>
<li><code>db.session()</code>: Request a database session object which is used for executing SQL queries and other database operations. Returns an instance of <code>soci::session</code> object.</li>
</ul>
<h3><a class="anchor" id="autotoc_md154"></a>
Session</h3>
<p>The session method returns an instance that exposes the following methods and properties: </p><div class="fragment"><div class="line">const sess = db.session() // Lease a session for executing db actions</div>
</div><!-- fragment --><ul>
<li><code>sess.close()</code>: Close a specific database session. Note that, if the poolSize is greater than 1, this only closes the <em>sess</em> we borrowed earlier.</li>
<li><code>sess.reconnect()</code>: Reconnect the session instance.</li>
<li><code>sess.connected</code>: Property to get session instance connection status.</li>
<li><code>sess.begin</code></li>
<li><code>sess.commit</code></li>
<li><code>sess.rollback</code></li>
<li><code>sess.getQuery</code></li>
<li><code>sess.getLastQuery</code></li>
<li><code>sess.getLastQueryContext</code></li>
<li><code>sess.gotData</code></li>
<li><code>sess.getLastInsertId</code></li>
<li><code>sess.getBackendName</code></li>
<li><code>sess.emptyBlob</code></li>
</ul>
<h2><a class="anchor" id="autotoc_md155"></a>
Requests</h2>
<p>To add a new request endpoint in JS, Mantis exposes a <code>addRoute</code> method having the following signature:</p>
<div class="fragment"><div class="line">app.addRoute(method, path, function_handler) </div>
<div class="line">// With Middlewares</div>
<div class="line">app.addRoute(method, path, function_handler, middleware1, middleware2, ...)</div>
</div><!-- fragment --><p> Let's add a <code>/test</code> route. </p><div class="fragment"><div class="line">app.addRoute(&quot;GET&quot;, &quot;/test&quot;, function (req, res){</div>
<div class="line">    // Request Handler Method</div>
<div class="line">    res.json(200, JSON.stringify({a: 5, b: 4}))</div>
<div class="line">}) </div>
<div class="line"> </div>
<div class="line">// With one or more middlewares</div>
<div class="line">app.addRoute(&quot;GET&quot;, &quot;/test&quot;, function (req, res){</div>
<div class="line">    // Request Handler Method</div>
<div class="line">    res.json(200, JSON.stringify({a: 5, b: 4}))</div>
<div class="line">}, function (req, res){</div>
<div class="line">    // Handler Body</div>
<div class="line">    </div>
<div class="line">    // If the middleware is successful, return true</div>
<div class="line">    // if we encounter an error, return false to abort route execution</div>
<div class="line">    return true</div>
<div class="line">}) </div>
</div><!-- fragment --><p>To access the request metadata as well as set response metadata, the handler or middleware method passes in two arguments, the request object (shown as <code>req</code> above) and the response object (shown as <code>res</code> above).</p>
<p>The <code>req</code> object maps to <code>MantisRequest</code> and <code>res</code> maps to <code>MantisResponse</code> class in C++.</p>
<h3><a class="anchor" id="autotoc_md156"></a>
Middlewares</h3>
<p>Middlewares in Mantis carries the same function signature as the request handler with just one tiny difference. The middlewares return a <code>bool</code> type, indicating whether or not the middleware executed successfully. That is;</p><ul>
<li>Return <code>true</code>: Middleware execution succeeded, proceed to the next handler and or handler.</li>
<li>Return <code>false</code>: Middleware execution failed, abort request.</li>
</ul>
<div class="fragment"><div class="line">function checkIfAuthenticated(req, res) {</div>
<div class="line">    var authenticated = false;</div>
<div class="line"> </div>
<div class="line">    // Do your magic here</div>
<div class="line">    var token = req.getHeader(&quot;Authorization&quot;, &quot;&quot;, 0)</div>
<div class="line">    // Validate token ...</div>
<div class="line">    // Other magic?</div>
<div class="line">    // authenticated = ....</div>
<div class="line">    </div>
<div class="line">    return authenticated</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">// Middleware is executed first before the handler</div>
<div class="line">app.addRoute(&quot;POST&quot;, &quot;/foo/bar&quot;, function (req, res) {}, checkIfAuthenticated)</div>
</div><!-- fragment --><blockquote class="doxtable">
<p>&zwj;Warning Note that, middlewares are executed from the first to the last in that order. That is, <code>app.addRoute(...., middleware_1, middleware_2, function(req, res){ return true}, ...)</code> executing from <code>middleware_1</code> to <code>middleware_n</code> the finally invoking the handler. </p>
</blockquote>
<h3><a class="anchor" id="autotoc_md157"></a>
MantisRequest Methods/Properties</h3>
<ul>
<li><code>req.hasHeader("Authorization")</code>: return true/false</li>
<li><code>req.getHeader("Authorization", "", 0)</code>: Return Authorization value or default</li>
<li><code>req.getHeaderCount("key")</code>: Count for header values given the header key</li>
<li><code>req.setHeader("Cow", "Cow Value")</code></li>
<li><code>req.hasTrailer</code></li>
<li><code>req.getTrailer</code></li>
<li><code>req.getTrailerCount</code></li>
<li><code>req.hasQueryParam("key")</code>: return true/false</li>
<li><code>req.getQueryParam("key")</code>: Return header value given the key</li>
<li><code>req.getQueryParamCount("key")</code>: Return parameter value count</li>
<li><code>req.hasPathParam("key")</code>: return true/false</li>
<li><code>req.getPathParam("key")</code>: Return header value given the key</li>
<li><code>req.getPathParamCount("key")</code>: Return parameter value count</li>
<li><code>req.isMultipartFormData()</code>: Return true if request type is of Multipart/FormData</li>
<li><code>req.body</code>: Get request body data</li>
<li><code>req.method</code>: Get request method ('GET', 'POST', ...)</li>
<li><code>req.path</code>: Get request path value</li>
<li><code>req.remoteAddr</code>: Remote request address</li>
<li><code>req.remotePort</code>: Remote request port</li>
<li><code>req.localAddr</code>: Local request address</li>
<li><code>req.localPort</code>: Local request port</li>
<li><code>req.hasKey("key")</code>: Returns true if the context store contains the given key.</li>
<li><code>req.set("key", value)</code>: Store in the context store the given key and value. Note only <code>int</code>, <code>float</code>, <code>double</code>, <code>strings</code> and <code>objects</code> are supported for now.</li>
<li><code>req.get("key")</code>: Get a value from the context store given the <code>key</code>.</li>
<li><code>req.getOr("key", "default value")</code>: Returns a value if <code>key</code> is in the context store else the default value.</li>
</ul>
<h3><a class="anchor" id="autotoc_md158"></a>
MantisResponse Methods/Properties</h3>
<ul>
<li><code>res.hasHeader("Authorization")</code>: Check if a header <code>key</code> exists in the request header. Returns true or false.</li>
<li><code>res.getHeader(&lt;key&gt;, &lt;default&gt;, &lt;index&gt;)</code>: Get header value for a given <code>key</code> in the header. All three parameters are required, <code>key</code> being the header of interest, <code>default</code> being the base value if header is not found and <code>index</code> being the 0-based index for the item to return if the header value has more than one value. i.e <div class="fragment"><div class="line">const token = res.getHeader(&quot;Authorization&quot;, &quot;&quot;, 0)</div>
<div class="line">const type = res.getHeader(&quot;content-type&quot;, &quot;text/plain&quot;, 0)</div>
</div><!-- fragment --></li>
<li><code>res.getHeaderCount("key")</code> -&gt; Count for header values given the header key</li>
<li><code>res.setHeader("Cow", "Cow Value")</code></li>
<li><code>res.hasTrailer</code></li>
<li><code>res.getTrailer</code></li>
<li><code>res.getTrailerCount</code></li>
<li><code>res.redirect("http://some-url.com", 302)</code></li>
<li><code>res.setContent(content, content_type)</code>: i.e. <code>res.setContent("&lt;html&gt;...&lt;/html&gt;", "text/html")</code></li>
<li><code>res.setFileContent("/foo/file_path")</code></li>
<li><code>res.send(200, "some data here", "text/plain")</code></li>
<li><code>res.json(200, "{\"a\": 5}")</code></li>
<li><code>res.html(200, "&lt;html&gt; ... &lt;/html&gt;")</code></li>
<li><code>res.text(200, "some text response")</code></li>
<li><code>res.empty(204)</code></li>
<li><code>res.body = "Some Data"</code></li>
<li><code>res.body</code> -&gt; returns <code>Some Data</code></li>
<li><code>res.status</code> (get or set status data)</li>
<li><code>res.version</code> (get or set version value)</li>
<li><code>res.location</code> (get or set redirect location value)</li>
<li><code>res.reason</code> (get or set reason value)</li>
</ul>
<h2><a class="anchor" id="autotoc_md159"></a>
Utils (utility functions)</h2>
<p>Mantis exposes an object <code>utils</code> which has the following utility functions.</p><ul>
<li><code>utils.generateTimeBasedId()</code></li>
<li><code>utils.generateReadableTimeId()</code></li>
<li><code>utils.generateShortId(char_count)</code></li>
<li><code>utils.getEnvOrDefault(key, default_value)</code></li>
<li><code>utils.sanitizeFilename(file_name)</code></li>
<li><code>utils.bcryptBase64Encode(data)</code></li>
<li><code>utils.generateSalt(char_count)</code></li>
<li><code>utils.hashPassword(password)</code></li>
<li><code>utils.verifyPassword(password, stored_password)</code> </li>
</ul>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.8 </li>
  </ul>
</div>
</body>
</html>
